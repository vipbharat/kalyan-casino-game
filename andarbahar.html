<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANDAR BAHAR ULTRA VIP</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --andar: #ff3333; --bahar: #33aaff; --gold: #ffd700; }
        body { margin: 0; background: #050505; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; user-select: none; padding-bottom: 120px; }
        
        /* TOP BAR: Date & Online Players */
        .top-bar { display: flex; justify-content: space-between; padding: 10px; background: #111; border-bottom: 2px solid var(--gold); align-items: center; }
        .top-left { font-size: 10px; color: var(--gold); line-height: 1.4; }
        .bal-box { background: #222; border: 1.5px solid var(--gold); padding: 4px 12px; border-radius: 20px; color: var(--gold); font-size: 14px; font-weight: bold; }
        
        /* ADMIN NOTIFICATION BAR */
        .admin-note-bar { background: #800; color: #fff; font-size: 12px; height: 22px; line-height: 22px; overflow: hidden; white-space: nowrap; border-bottom: 1.5px solid var(--gold); font-weight: bold; }

        .joker-section { text-align: center; margin-top: 5px; }
        .joker-card { width: 55px; height: 80px; background: #fff; border-radius: 8px; margin: 0 auto; border: 2.5px solid var(--gold); box-shadow: 0 0 10px var(--gold); overflow: hidden; }
        .joker-card img { width: 100%; height: 100%; object-fit: fill; }
        
        .timer-sec { font-size: 32px; color: var(--gold); text-align: center; margin: 2px 0; height: 40px; font-weight: 900; }

        .table-top { display: flex; justify-content: center; gap: 35px; margin-top: 10px; }
        .card-slot { width: 62px; height: 85px; background: rgba(255,255,255,0.05); border-radius: 6px; border: 2px solid #333; position: relative; display: flex; align-items: center; justify-content: center; }
        .card-slot img { width: 100%; height: 100%; border-radius: 4px; display: none; }
        .card-back { background: url('https://deckofcardsapi.com/static/img/back.png') center/cover; position: absolute; width: 100%; height: 100%; z-index: 5; border-radius: 4px; }

        #win-overlay { position: fixed; top: 60%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; font-size: 22px; font-weight: 900; background: rgba(0,0,0,0.95); padding: 12px 30px; border-radius: 12px; border: 3px solid var(--gold); color: gold; text-align: center; width: 65%; pointer-events: none; box-shadow: 0 0 20px #000; }

        /* ✅ BORDER FIXED: Mota, Bright aur Glowing Borders */
        .bet-grid { display: flex; justify-content: center; gap: 8px; margin-top: 15px; }
        .box { width: 165px; height: 190px; border: 3.5px solid rgba(255,255,255,0.4); border-radius: 12px; position: relative; background: rgba(0,0,0,0.6); overflow: hidden; transition: all 0.3s; }
        .andar-box { border-color: var(--andar) !important; box-shadow: inset 0 0 15px rgba(255, 51, 51, 0.4), 0 0 10px rgba(255, 51, 51, 0.2); } 
        .bahar-box { border-color: var(--bahar) !important; box-shadow: inset 0 0 15px rgba(51, 170, 255, 0.4), 0 0 10px rgba(51, 170, 255, 0.2); }
        
        .pool-amt { display: block; background: rgba(0,0,0,0.85); color: #0f0; text-align: center; font-size: 15px; padding: 5px; font-weight: bold; border-bottom: 2px solid rgba(255,255,255,0.2); }
        
        .chip { width: 18px; height: 18px; border-radius: 50%; border: 0.5px solid #fff; position: absolute; z-index: 20; font-size: 7px; font-weight: 900; display: flex; align-items: center; justify-content: center; box-shadow: 0 1px 3px #000; }

        .live-players { display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px; padding: 5px 0; background: #000; position: fixed; bottom: 85px; width: 100%; border-top: 1px solid #333; }
        .player { text-align: center; }
        .p-avatar { width: 25px; height: 25px; background: #222; border: 1px solid gold; border-radius: 50%; margin: 0 auto; line-height: 24px; font-size: 7px; color: #fff; }

        .chip-footer { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: center; gap: 6px; padding: 15px 0; border-top: 2px solid var(--gold); z-index: 1100; }
        .c-btn { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; cursor: pointer; border: 2px dashed #fff; color: white; font-size: 13px; }
        .selected { transform: scale(1.1); border: 3px solid var(--gold) !important; box-shadow: 0 0 15px var(--gold); }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="top-left">
        <div id="live-date">--/--/--</div>
        <div id="online-count" style="color:#0f0; font-weight:bold;">● 584 Online</div>
    </div>
    <div class="top-right">
        <div class="bal-box">₹ <span id="balance">0.00</span></div>
    </div>
</div>

<div class="admin-note-bar"><marquee id="admin-notif">WELCOME TO KALYAN VIP CASINO - FASTEST SETTLEMENT</marquee></div>

<div class="joker-section">
    <div class="joker-card"><img id="joker-img" src="https://deckofcardsapi.com/static/img/back.png"></div>
</div>

<div class="timer-sec" id="timer">15</div>

<div class="table-top">
    <div style="text-align:center">
        <div style="font-size:10px; color:var(--andar); margin-bottom:3px;">ANDAR</div>
        <div class="card-slot" id="slot-andar"><div class="card-back" id="back-a"></div><img id="img-a"></div>
    </div>
    <div style="text-align:center">
        <div style="font-size:10px; color:var(--bahar); margin-bottom:3px;">BAHAR</div>
        <div class="card-slot" id="slot-bahar"><div class="card-back" id="back-b"></div><img id="img-b"></div>
    </div>
</div>

<div id="win-overlay">WINNER</div>

<div class="bet-grid">
    <div class="box andar-box" onclick="placeBet('andar')">
        <span class="pool-amt">₹<span id="p-andar">0</span></span>
        <div id="chips-andar"></div>
    </div>
    <div class="box bahar-box" onclick="placeBet('bahar')">
        <span class="pool-amt">₹<span id="p-bahar">0</span></span>
        <div id="chips-bahar"></div>
    </div>
</div>

<div class="live-players" id="player-row"></div>

<div class="chip-footer">
    <div class="c-btn" id="chip10" style="background:#fff; color:#000" onclick="setChip(10, this)">10</div>
    <div class="c-btn" id="chip100" style="background:#2196f3;" onclick="setChip(100, this)">100</div>
    <div class="c-btn" id="chip500" style="background:#4caf50; color:#000" onclick="setChip(500, this)">500</div>
    <div class="c-btn" id="chip1000" style="background:#f44336;" onclick="setChip(1000, this)">1K</div>
    <div class="c-btn" id="chip5000" style="background:#ffd700; color:#000" onclick="setChip(5000, this)">5K</div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", projectId: "kalyan-casino" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const phone = localStorage.getItem('userPhone');

    const cardSuits = ["S", "H", "D", "C"];
    const cardValues = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "0", "J", "Q", "K"];
    const chipConfig = { 10:{b:"#fff",c:"#000",t:"10"}, 100:{b:"#2196f3",c:"#fff",t:"100"}, 500:{b:"#4caf50",c:"#000",t:"500"}, 1000:{b:"#f44336",c:"#fff",t:"1K"}, 5000:{b:"#ffd700",c:"#000",t:"5K"} };

    let currentChip = 10, isBetting = false, totalBal = 0, jokerVal = "", jokerSuit = "";
    let pool = {andar:0, bahar:0}, myBets = {andar:0, bahar:0}, bots = [];

    function updateHeader() {
        document.getElementById('live-date').innerText = new Date().toLocaleDateString();
        setInterval(() => {
            let online = Math.floor(Math.random() * 200) + 550;
            document.getElementById('online-count').innerText = `● ${online} Online`;
        }, 4000);
    }

    db.ref('admin_settings/notification').on('value', s => { if(s.val()) document.getElementById('admin-notif').innerText = s.val(); });

    function initBots() {
        bots = [];
        for(let i=0; i<10; i++) bots[i] = { id: Math.floor(Math.random()*8999)+1000, bal: Math.floor(Math.random()*95001)+10000, side:'', amt:0 };
        renderBots();
    }

    function renderBots() {
        const row = document.getElementById('player-row'); row.innerHTML = "";
        bots.forEach(b => { 
            row.innerHTML += `<div class="player"><div class="p-avatar">ID</div><div style="font-size:7px;color:#0f0">ID ${b.id}</div><div style="font-size:7px;color:gold">₹${Math.floor(b.bal).toLocaleString()}</div></div>`; 
        });
    }

    function startEngine() {
        const loopTime = 40000;
        setInterval(() => {
            const now = Date.now();
            const cyclePos = now % loopTime;
            const remaining = Math.floor((15000 - cyclePos) / 1000);

            if (cyclePos < 15000) {
                if(!isBetting) { 
                    isBetting = true; 
                    jokerVal = cardValues[Math.floor(Math.random()*13)];
                    jokerSuit = cardSuits[Math.floor(Math.random()*4)];
                    resetUI(jokerVal, jokerSuit); 
                }
                document.getElementById('timer').innerText = remaining > 0 ? remaining : "0";
                botBetting();
            } else if (isBetting) {
                isBetting = false; 
                document.getElementById('timer').innerText = "STOP!"; 
                processGame(); 
            }
        }, 1000);
    }

    function botBetting() {
        let count = Math.floor(Math.random()*10)+8; 
        for(let i=0; i<count; i++) {
            let bIdx = Math.floor(Math.random()*10);
            let s = Math.random() > 0.5 ? 'andar' : 'bahar';
            let a = [10, 100, 500, 1000, 5000][Math.floor(Math.random()*5)];
            if(bots[bIdx].bal >= a) { 
                bots[bIdx].bal -= a; 
                bots[bIdx].side = s; 
                bots[bIdx].amt += a; 
                pool[s] += a; 
                spawnChip(s, a); 
            }
        }
        document.getElementById('p-andar').innerText = pool.andar.toLocaleString();
        document.getElementById('p-bahar').innerText = pool.bahar.toLocaleString();
        renderBots(); // Live Refresh Balance
    }

    async function processGame() {
        let win = (pool.andar <= pool.bahar) ? 'andar' : 'bahar';
        let matched = false, step = 0;
        while(!matched) {
            step++;
            let side = (step % 2 !== 0) ? 'andar' : 'bahar';
            let resVal = (step > 6 && side === win) ? jokerVal : cardValues[Math.floor(Math.random()*13)];
            let resSuit = cardSuits[Math.floor(Math.random()*4)];
            if(resVal === jokerVal && side !== win) resVal = (resVal==="A")?"K":"2";

            const slotImg = document.getElementById(side==='andar'?'img-a':'img-b');
            const slotBack = document.getElementById(side==='andar'?'back-a':'back-b');
            
            const nextImg = new Image();
            nextImg.src = `https://deckofcardsapi.com/static/img/${resVal}${resSuit}.png`;
            
            await new Promise(r => { nextImg.onload = r; setTimeout(r, 900); });

            slotImg.src = nextImg.src;
            slotBack.style.display = 'none';
            slotImg.style.display = 'block';

            if(resVal === jokerVal) {
                matched = true;
                const ov = document.getElementById('win-overlay');
                ov.innerText = side.toUpperCase() + " WINS"; ov.style.display = 'block';
                
                bots.forEach(b => { 
                    if(b.side === side) b.bal += (b.amt * 1.95); 
                    b.side=''; b.amt=0; 
                });
                renderBots(); // Win Refresh balance

                if(myBets[side] > 0 && phone) {
                    db.ref('users/'+phone).once('value', s => {
                        let b = (s.val().balance || 0) + (myBets[side] * 1.95);
                        db.ref('users/'+phone).update({balance: b});
                    });
                }
                return;
            }
            
            await new Promise(r => setTimeout(r, 1600)); 
            slotImg.style.display = 'none';
            slotBack.style.display = 'block';
            await new Promise(r => setTimeout(r, 600));
        }
    }

    function spawnChip(side, amt) {
        const div = document.getElementById('chips-'+side);
        const config = chipConfig[amt] || chipConfig[10];
        const c = document.createElement('div');
        c.className = 'chip'; c.style.background = config.b; c.style.color = config.c; c.innerText = config.t;
        c.style.left = (Math.random()*75+10)+"%"; c.style.top = (Math.random()*65+20)+"%";
        div.appendChild(c);
        if(div.children.length > 80) div.firstChild.remove();
    }

    function placeBet(side) {
        if(!isBetting || totalBal < currentChip) return;
        db.ref('users/'+phone).once('value', s => {
            let b = s.val().balance || 0;
            if(b >= currentChip) {
                db.ref('users/'+phone).update({balance: b - currentChip});
                myBets[side] += currentChip; pool[side] += currentChip;
                spawnChip(side, currentChip);
            }
        });
    }

    function resetUI(val, suit) {
        document.getElementById('win-overlay').style.display = 'none';
        document.getElementById('joker-img').src = `https://deckofcardsapi.com/static/img/${val}${suit}.png`;
        document.getElementById('img-a').style.display = 'none'; document.getElementById('img-b').style.display = 'none';
        document.getElementById('back-a').style.display = 'block'; document.getElementById('back-b').style.display = 'block';
        document.querySelectorAll('.chip').forEach(c => c.remove());
        pool = {andar:0, bahar:0}; myBets = {andar:0, bahar:0};
        document.getElementById('p-andar').innerText = "0"; document.getElementById('p-bahar').innerText = "0";
        initBots();
    }

    function setChip(v, el) { currentChip = v; document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); }
    if(phone) db.ref('users/'+phone).on('value', s => { totalBal = s.val().balance || 0; document.getElementById('balance').innerText = totalBal.toFixed(2); });
    
    document.getElementById('chip10').classList.add('selected');
    updateHeader(); startEngine();
</script>
</body>
</html>
