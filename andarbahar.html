<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ANDAR BAHAR PRO MAX</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --andar: #ff3333; --bahar: #33aaff; --gold: #ffd700; }
        body { margin: 0; background: #050505; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; user-select: none; }
        .top-bar { display: flex; justify-content: space-between; padding: 8px; background: #111; border-bottom: 2px solid var(--gold); position: relative; z-index: 100; }
        .bal-box { background: #222; border: 1.5px solid var(--gold); padding: 4px 12px; border-radius: 20px; color: var(--gold); font-size: 14px; }
        .online-status { position: absolute; left: 10px; top: 35px; font-size: 10px; color: #0f0; }
        .history { display: flex; gap: 4px; padding: 6px; background: rgba(20,20,20,0.9); height: 28px; overflow-x: auto; border-bottom: 1px solid #333; align-items: center; }
        .hist-item { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; border: 1.2px solid #fff; flex-shrink: 0; font-weight: bold; }
        .h-a { background: var(--andar); } .h-b { background: var(--bahar); }
        .joker-container { display: flex; flex-direction: column; align-items: center; margin-top: 5px; }
        .joker-card { width: 50px; height: 70px; background: #fff; border-radius: 8px; color: #000; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 2.5px solid var(--gold); box-shadow: 0 0 10px var(--gold); }
        .timer-sec { font-size: 32px; color: var(--gold); margin: 2px 0; font-weight: 900; }
        .table-top { display: flex; justify-content: center; gap: 50px; height: 90px; margin-top: 5px; }
        .card-wrapper { position: relative; text-align: center; }
        .label-fix { font-size: 11px; font-weight: 900; margin-bottom: 4px; letter-spacing: 1px; }
        .card { width: 52px; height: 70px; background: #fff; border-radius: 6px; position: relative; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #000; border: 2px solid #999; }
        .card-back { background: linear-gradient(135deg, #b30000 0%, #ff0000 100%); position: absolute; width: 100%; height: 100%; z-index: 5; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: gold; font-size: 20px; border: 1px solid gold; font-weight: 900; }
        .bet-grid { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .box { width: 148px; height: 180px; border: 2.5px solid rgba(255,255,255,0.15); border-radius: 12px; position: relative; background: rgba(255,255,255,0.03); overflow: hidden; }
        .andar-box { border-color: var(--andar); } .bahar-box { border-color: var(--bahar); }
        .pool-amt { display: block; background: rgba(0,0,0,0.85); color: #0f0; text-align: center; font-size: 13px; padding: 4px; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .live-players { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 6px 0; background: rgba(0,0,0,0.9); position: fixed; bottom: 82px; width: 100%; border-top: 1px solid #333; }
        .p-avatar { width: 26px; height: 26px; background: #222; border: 1px solid gold; border-radius: 50%; margin: 0 auto; line-height: 26px; font-size: 7px; color: #fff; text-align: center; }
        .chip { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #fff; position: absolute; z-index: 10; font-size: 7px; font-weight: 900; display: flex; align-items: center; justify-content: center; animation: chipDrop 0.3s ease-out; box-shadow: 0 2px 4px #000; }
        @keyframes chipDrop { from { transform: scale(1.8) translateY(-30px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .chip-footer { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: center; gap: 5px; padding: 12px 0; border-top: 2px solid var(--gold); }
        .c-btn { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 10px; cursor: pointer; border: 2px dashed #fff; color: white; }
        .selected { transform: scale(1.1) translateY(-4px); border: 2.5px solid var(--gold) !important; box-shadow: 0 0 12px var(--gold); }
        #win-overlay { position: fixed; top: 45%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; font-size: 24px; font-weight: 900; background: rgba(0,0,0,0.95); padding: 12px 25px; border-radius: 10px; border: 3px solid var(--gold); color: gold; text-align: center; }
    </style>
</head>
<body onload="initBots(); startEngine(); updateOnlineCount();">

<div class="top-bar">
    <div style="font-size:10px; color:var(--gold)">ANDAR BAHAR MASTER</div>
    <div class="online-status" id="online-count">● 542 Online</div>
    <div class="bal-box">₹ <span id="balance">0.00</span></div>
</div>
<div class="history" id="hist-bar"></div>
<div class="joker-container">
    <div class="joker-card"><div id="joker-val">?</div></div>
    <div class="timer-sec" id="timer">15</div>
</div>
<div class="table-top">
    <div class="card-wrapper">
        <div class="label-fix" style="color:var(--andar)">ANDAR (A)</div>
        <div class="card" id="card-a"><div class="card-back">A</div><div id="a-v"></div></div>
    </div>
    <div class="card-wrapper">
        <div class="label-fix" style="color:var(--bahar)">BAHAR (B)</div>
        <div class="card" id="card-b"><div class="card-back">B</div><div id="b-v"></div></div>
    </div>
</div>
<div class="bet-grid">
    <div class="box andar-box" onclick="placeBet('andar')">
        <span class="pool-amt">₹<span id="p-andar">0</span></span>
        <div id="chips-andar"></div>
    </div>
    <div class="box bahar-box" onclick="placeBet('bahar')">
        <span class="pool-amt">₹<span id="p-bahar">0</span></span>
        <div id="chips-bahar"></div>
    </div>
</div>
<div class="live-players" id="player-row"></div>
<div class="chip-footer">
    <div class="c-btn" style="background:#fff; color:#000" onclick="setChip(10, this)">10</div>
    <div class="c-btn" style="background:#e91e63;" onclick="setChip(50, this)">50</div>
    <div class="c-btn" style="background:#2196f3;" onclick="setChip(100, this)">100</div>
    <div class="c-btn" style="background:#4caf50; color:#000" onclick="setChip(500, this)">500</div>
    <div class="c-btn" style="background:#f44336;" onclick="setChip(1000, this)">1K</div>
    <div class="c-btn" style="background:#ffd700; color:#000" onclick="setChip(5000, this)">5K</div>
</div>
<div id="win-overlay">WINNER</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", projectId: "kalyan-casino" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const phone = localStorage.getItem('userPhone');

    const namesList = ["Tiger", "Rahul", "Zoya", "Vicky", "Kabir", "Arjun", "Sona", "Don7", "Bhai", "Queen", "Jatt", "King", "Raja", "Sunny", "Rohan", "Priya", "Vip_1", "Pro_G", "Ace"];
    const chipConfig = { 10: { bg: "#ffffff", txt: "#000" }, 50: { bg: "#e91e63", txt: "#fff" }, 100: { bg: "#2196f3", txt: "#fff" }, 500: { bg: "#4caf50", txt: "#000" }, 1000: { bg: "#f44336", txt: "#fff" }, 5000: { bg: "#ffd700", txt: "#000" } };

    let totalBal = 0, currentChip = 10, time = 15, isBetting = false, roundJoker = "", adminCommand = "auto";
    let pool = {andar:0, bahar:0}, myBets = {andar:0, bahar:0}, bots = [];
    const deck = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

    // 1. History & Admin Signal Listener
    db.ref('game_history').limitToLast(20).on('value', s => {
        const h = document.getElementById('hist-bar'); h.innerHTML = "";
        const data = s.val() || {};
        Object.values(data).reverse().forEach(v => {
            let cls = (v==='andar')?'h-a':'h-b';
            h.innerHTML += `<div class="hist-item ${cls}">${(v==='andar'?'A':'B')}</div>`;
        });
    });

    db.ref('manual_result').on('value', s => { adminCommand = s.val() || "auto"; });

    function updateOnlineCount() { setInterval(() => { let count = Math.floor(Math.random() * 20) + 530; document.getElementById('online-count').innerText = `● ${count} Online`; }, 3000); }
    function createNewBot() { return { name: namesList[Math.floor(Math.random() * namesList.length)], bal: Math.floor(Math.random() * 50000) + 15000, side: null, amt: 0 }; }
    function initBots() { for(let i=0; i<10; i++) bots[i] = createNewBot(); renderBots(); }
    function renderBots() {
        const row = document.getElementById('player-row'); row.innerHTML = "";
        bots.forEach((b, i) => { if (b.bal < 1000) bots[i] = createNewBot(); row.innerHTML += `<div class="player"><div class="p-avatar">${bots[i].name}</div><div style="font-size:7px;color:#0f0">₹${bots[i].bal.toLocaleString()}</div></div>`; });
    }

    function startEngine() {
        resetUI();
        roundJoker = deck[Math.floor(Math.random()*13)];
        document.getElementById('joker-val').innerText = roundJoker;
        time = 15; isBetting = true;
        let loop = setInterval(() => {
            if(time > 0) { 
                document.getElementById('timer').innerText = time; 
                if(time > 1) botBetting();
                time--; 
            } else { clearInterval(loop); isBetting = false; processGame(); }
        }, 1000);
    }

    function botBetting() {
        bots.forEach(b => {
            if(Math.random() > 0.6) {
                let s = Math.random() > 0.5 ? 'andar' : 'bahar';
                let a = [50, 100, 500, 1000, 5000][Math.floor(Math.random()*5)];
                if(b.bal >= a) { b.bal -= a; pool[s] += a; b.side = s; b.amt = a; updatePoolUI(); spawnChip(s, a); renderBots(); }
            }
        });
    }

    async function processGame() {
        // ADMIN Logic: manual or auto profit
        let win = "andar";
        if(adminCommand === "andar") win = "andar";
        else if(adminCommand === "bahar") win = "bahar";
        else win = (pool.andar <= pool.bahar) ? "andar" : "bahar";

        let matched = false, step = 0;
        while(!matched) {
            step++;
            let side = (step % 2 !== 0) ? 'andar' : 'bahar';
            let cardVal = deck[Math.floor(Math.random()*13)];
            if(step > 6 && side === win) cardVal = roundJoker;
            else if(cardVal === roundJoker) cardVal = (roundJoker==='A')?'K':'Q';

            document.getElementById(side === 'andar' ? 'a-v' : 'b-v').innerText = cardVal;
            document.querySelector(`#card-${side === 'andar' ? 'a' : 'b'} .card-back`).style.display = 'none';

            if(cardVal === roundJoker) {
                matched = true;
                document.getElementById('win-overlay').innerHTML = side.toUpperCase() + " WINS";
                document.getElementById('win-overlay').style.display = 'block';
                bots.forEach(b => { if(b.side === side) b.bal += Math.floor(b.amt * 1.95); b.side = null; b.amt = 0; });
                renderBots();
                db.ref('game_history').push(side);
                if(myBets[side] > 0) db.ref('users/'+phone+'/winning_balance').transaction(bal => (parseFloat(bal)||0) + (myBets[side]*1.95));
            }
            await new Promise(r => setTimeout(r, 1400));
            if(!matched) {
                document.getElementById(side === 'andar' ? 'a-v' : 'b-v').innerText = "";
                document.querySelector(`#card-${side === 'andar' ? 'a' : 'b'} .card-back`).style.display = 'flex';
            }
        }
        setTimeout(startEngine, 5000);
    }

    function spawnChip(side, amt) {
        const div = document.getElementById('chips-'+side);
        const config = chipConfig[amt] || chipConfig[10];
        const c = document.createElement('div');
        c.className = 'chip'; c.style.background = config.bg; c.style.color = config.txt; 
        c.innerText = amt >= 1000 ? (amt/1000)+'K' : amt;
        c.style.left = Math.random()*70+10+"%"; c.style.top = Math.random()*70+15+"%";
        div.appendChild(c);
        if(div.children.length > 30) div.firstChild.remove();
    }

    function placeBet(side) {
        if(!isBetting || time <= 1 || totalBal < currentChip) return;
        db.ref('users/'+phone).once('value', s => {
            const d = s.val() || {}; let b = parseFloat(d.balance||0), w = parseFloat(d.winning_balance||0);
            if(b >= currentChip) b -= currentChip; else if(w >= currentChip) w -= currentChip; else return;
            db.ref('users/'+phone).update({balance:b, winning_balance:w});
            myBets[side] += currentChip; pool[side] += currentChip; updatePoolUI(); spawnChip(side, currentChip);
        });
    }

    function setChip(v, el) { currentChip = v; document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); }
    function updatePoolUI() { document.getElementById('p-andar').innerText = pool.andar.toLocaleString(); document.getElementById('p-bahar').innerText = pool.bahar.toLocaleString(); }
    function resetUI() { document.getElementById('win-overlay').style.display = 'none'; document.getElementById('a-v').innerText = ""; document.getElementById('b-v').innerText = ""; document.querySelectorAll('.card-back').forEach(b => b.style.display = 'flex'); document.querySelectorAll('.chip').forEach(c => c.remove()); pool = {andar:0, bahar:0}; myBets = {andar:0, bahar:0}; updatePoolUI(); }
    if(phone) { db.ref('users/'+phone).on('value', s => { const d = s.val() || {}; totalBal = (parseFloat(d.balance)||0) + (parseFloat(d.winning_balance)||0); document.getElementById('balance').innerText = totalBal.toFixed(2); }); }
</script>
</body>
</html>
