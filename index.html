<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", 
        databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", 
        projectId: "kalyan-casino" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let generatedOTP = "";

    function showTab(type) {
        document.getElementById('login-form').classList.toggle('hidden', type === 'reg');
        document.getElementById('reg-form').classList.toggle('hidden', type === 'login');
        document.getElementById('login-tab').classList.toggle('active', type === 'login');
        document.getElementById('reg-tab').classList.toggle('active', type === 'reg');
        document.getElementById('timer-box').innerText = "";
    }

    // --- ðŸŸ¢ STEP 1: SEND OTP (10 SECOND DELAY) ---
    function checkUserAndSend() {
        const ph = document.getElementById('r-phone').value.trim();
        const btn = document.getElementById('auth-btn');
        const timerTxt = document.getElementById('timer-box');

        if(ph.length !== 10) return alert("10-digit number daalein!");

        db.ref('users/' + ph).once('value', s => {
            if(s.exists()) {
                alert("Number pehle se registered hai!");
            } else {
                // Timer Shuru: OTP aane se pehle 10 second wait
                btn.disabled = true;
                let waitTime = 10;
                
                let otpTimer = setInterval(() => {
                    timerTxt.innerText = "ðŸ“© Sending Secure OTP: " + waitTime + "s";
                    waitTime--;

                    if(waitTime < 0) {
                        clearInterval(otpTimer);
                        timerTxt.innerText = "âœ… OTP Sent Successfully!";
                        
                        // Ab OTP dikhao
                        generatedOTP = Math.floor(100000 + Math.random() * 899999);
                        document.getElementById('visual-otp').innerText = generatedOTP;
                        document.getElementById('otp-section').classList.remove('hidden');
                        
                        // Button ko Verify ke liye ready karo
                        btn.disabled = false;
                        btn.innerText = "VERIFY & LOGIN";
                        btn.onclick = verifyAndRedirect; 
                    }
                }, 1000);
            }
        });
    }

    // --- ðŸŸ¢ STEP 2: VERIFY AND DIRECT TO DASHBOARD ---
    function verifyAndRedirect() {
        const ph = document.getElementById('r-phone').value.trim();
        const otp = document.getElementById('r-otp').value.trim();
        const p1 = document.getElementById('r-pass1').value.trim();
        const p2 = document.getElementById('r-pass2').value.trim();

        if(otp != generatedOTP) return alert("âŒ Galat OTP!");
        if(p1 === "" || p1 !== p2) return alert("âŒ Passwords match nahi kar rahe!");

        // 6-Digit VIP ID
        const newVIP = "VIP" + Math.floor(100000 + Math.random() * 899999);

        // Database mein save karo aur Dashboard pe bhejo
        db.ref('users/' + ph).set({
            phone: ph,
            password: p1,
            balance: 51.00,
            uid: newVIP,
            joined: new Date().toLocaleDateString()
        }).then(() => {
            localStorage.setItem('userPhone', ph);
            alert("Success! Your ID: " + newVIP);
            window.location.href = "dashboard.html"; // Seedha Dashboard
        });
    }

    // --- ðŸŸ¢ LOGIN LOGIC ---
    function loginUser() {
        const ph = document.getElementById('l-ph').value.trim();
        const ps = document.getElementById('l-ps').value.trim();
        db.ref('users/' + ph).once('value', s => {
            if(s.exists() && s.val().password === ps) {
                localStorage.setItem('userPhone', ph);
                window.location.href = "dashboard.html";
            } else {
                alert("Invalid Details!");
            }
        });
    }
</script>
