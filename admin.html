<script>
    // Firebase Setup
    const firebaseConfig = { 
        apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", 
        databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", 
        projectId: "kalyan-casino" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. ðŸŽ® GAME CONTROL (Fixing Paths)
    function masterControl(game, res) {
        const mode = (res === 'auto') ? 'auto' : 'manual';
        
        if(game === 'dvt') {
            // Dragon Tiger: Dono paths update honge taaki game script pick kar sake
            db.ref('game_settings/dvt').update({ mode: mode, result: res });
            db.ref('games/dragon_tiger').update({ mode: mode, result: res });
        } else {
            // Andar Bahar: Iska manual result humne 'manual_result_ab' rakha tha
            db.ref('game_settings/ab').update({ mode: mode, result: res });
            db.ref('manual_result_ab').set(res);
        }
        alert("âœ… " + game.toUpperCase() + " Set to " + res.toUpperCase());
    }

    // 2. ðŸ“¢ NOTICE & SETTINGS (Fixing Path)
    function updateNotif() {
        const msg = document.getElementById('notifMsg').value;
        // Game marquee isi path se data uthayega
        db.ref('admin_settings/notification').set(msg).then(() => alert("Notice Updated!"));
    }

    function updateSettings() {
        const upi = document.getElementById('adminUpi').value;
        const qr = document.getElementById('qrUrl').value;
        const wa = document.getElementById('waLink').value;
        const tg = document.getElementById('tgLink').value;

        db.ref('admin_settings').update({
            upi: upi,
            qr: qr,
            whatsapp: wa,
            telegram: tg
        }).then(() => alert("All Settings Saved!"));
    }

    // 3. ðŸ“© REQUESTS (Deposit/Withdrawal Sync)
    db.ref('requests').on('value', s => {
        let h = "";
        s.forEach(child => {
            let req = child.val();
            let id = child.key;
            h += `<tr>
                <td>${req.phone}</td>
                <td style="color:${req.type==='Deposit'?'#2ecc71':'#e74c3c'}">${req.type}</td>
                <td>â‚¹${req.amount}</td>
                <td>
                    <button class="btn-green" style="padding:5px;" onclick="manageRequest('${id}','${req.phone}',${req.amount},'${req.type}','approve')">Approve</button>
                    <button class="btn-red" style="padding:5px;" onclick="manageRequest('${id}','${req.phone}',${req.amount},'${req.type}','reject')">Reject</button>
                </td></tr>`;
        });
        document.getElementById('master-request-body').innerHTML = h;
    });

    function manageRequest(id, phone, amt, type, action) {
        if (action === 'approve' && type === 'Deposit') {
            db.ref('users/' + phone + '/balance').transaction(b => (parseFloat(b) || 0) + amt);
        } else if (action === 'reject' && type === 'Withdrawal') {
            db.ref('users/' + phone + '/balance').transaction(b => (parseFloat(b) || 0) + amt);
        }
        db.ref('requests/' + id).remove();
        alert("Request " + action);
    }

    // 4. ðŸ‘¥ USER LIST & WALLET (Already Working)
    function modifyWallet(action) {
        const ph = document.getElementById('userPhone').value;
        const amt = parseFloat(document.getElementById('newAmt').value);
        db.ref('users/' + ph + '/balance').transaction(b => action==='add'?(parseFloat(b)||0)+amt:(parseFloat(b)||0)-amt)
        .then(() => alert("Wallet Updated!"));
    }

    db.ref('users').on('value', s => {
        let h = ""; s.forEach(c => { 
            let d = c.val();
            h += `<tr><td>${c.key}</td><td>â‚¹${(d.balance||0).toFixed(2)}</td><td>${d.uid||'NA'}</td></tr>`; 
        });
        document.getElementById('all-users-data').innerHTML = h;
    });

    function openTab(evt, name) {
        let content = document.getElementsByClassName("content-section");
        for (let i = 0; i < content.length; i++) content[i].classList.remove("active-section");
        let tabs = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < tabs.length; i++) tabs[i].classList.remove("active");
        document.getElementById(name).classList.add("active-section");
        evt.currentTarget.classList.add("active");
    }
</script>
