<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRAGON TIGER PRO - FINAL REVISED</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        :root { --dragon: #ff3333; --tiger: #33aaff; --gold: #ffd700; }
        body { margin: 0; background: #050505; font-family: 'Segoe UI', Arial; overflow: hidden; color: white; user-select: none; }
        
        /* UI Styling */
        .top-bar { display: flex; justify-content: space-between; padding: 10px; background: #111; border-bottom: 2px solid var(--gold); }
        .bal-box { background: #222; border: 1.5px solid var(--gold); padding: 5px 15px; border-radius: 20px; color: var(--gold); font-weight: bold; }
        .history { display: flex; gap: 4px; padding: 8px; justify-content: center; background: rgba(0,0,0,0.8); height: 25px; overflow: hidden; }
        .hist-item { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 1px solid #fff; }
        .h-d { background: var(--dragon); } .h-t { background: var(--tiger); } .h-ti { background: var(--gold); color: #000; }

        /* Patch White Cards */
        .timer-sec { text-align: center; font-size: 40px; font-weight: 900; color: var(--gold); margin: 5px 0; }
        .table { display: flex; justify-content: center; gap: 20px; align-items: center; height: 110px; }
        .card { 
            width: 75px; height: 105px; background: #ffffff !important; border-radius: 8px; 
            border: 2px solid #ccc; position: relative; display: flex; align-items: center; 
            justify-content: center; font-size: 32px; font-weight: 900; transition: 0.4s; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .suit-red { color: #ff0000; } .suit-black { color: #000000; }
        .card-back { background: linear-gradient(135deg, #a00, #400); position: absolute; width: 100%; height: 100%; z-index: 5; color: var(--gold); display: flex; align-items: center; justify-content: center; border-radius: 6px; }
        
        .winner-glow { 
            box-shadow: 0 0 30px 15px #fff, 0 0 50px 20px rgba(255,255,255,0.4) !important; 
            transform: scale(1.1); z-index: 50; border: 3px solid var(--gold) !important;
        }

        /* Betting Grid */
        .bet-grid { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .box { width: 120px; height: 200px; border: 2.5px solid rgba(255,255,255,0.1); border-radius: 12px; position: relative; background: rgba(255,255,255,0.05); overflow: hidden; }
        .dragon-box { border-color: var(--dragon); } .tiger-box { border-color: var(--tiger); } .tie-box { width: 85px; height: 140px; border-color: var(--gold); }
        .pool-amt { display: block; background: rgba(0,0,0,0.8); color: #0f0; text-align: center; font-family: monospace; font-size: 13px; padding: 4px; font-weight: bold; }
        
        .chip { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #fff; position: absolute; z-index: 10; display: flex; align-items: center; justify-content: center; font-size: 8px; font-weight: 900; box-shadow: 1px 1px 3px #000; }

        /* Bot Section */
        .live-players { display: flex; justify-content: space-around; padding: 10px 0; background: rgba(0,0,0,0.9); position: fixed; bottom: 85px; width: 100%; border-top: 1px solid #222; min-height: 65px; }
        .player { text-align: center; width: 65px; position: relative; transition: opacity 0.5s; }
        .p-avatar { width: 38px; height: 38px; background: #333; border-radius: 50%; margin: 0 auto; border: 1.5px solid var(--gold); line-height: 38px; font-size: 9px; overflow: hidden; white-space: nowrap; }
        .p-bal { font-size: 10px; color: #0f0; margin-top: 3px; font-weight: bold; }
        .p-anim { position: absolute; top: -15px; left: 0; width: 100%; font-weight: bold; font-size: 13px; opacity: 0; transition: 0.8s; z-index: 100; }

        /* Footer Chips */
        .chip-footer { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: center; gap: 6px; padding: 15px 0; border-top: 2px solid var(--gold); }
        .c-btn { width: 48px; height: 48px; border-radius: 50%; border: 2px dashed #fff; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 12px; color: white; cursor: pointer; }
        .selected { transform: scale(1.15) translateY(-5px); border-color: var(--gold) !important; box-shadow: 0 0 15px var(--gold); }
        .c10 { background: #fff; color: #000; } .c50 { background: #f0f; } .c100 { background: #00f; } .c500 { background: #0f0; } .c1k { background: #f00; }
        .c5k { background: linear-gradient(145deg, #ffd700, #aa8800); color: #000; border-style: solid !important; }

        #win-overlay { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; text-align: center; width: 100%; }
        .win-banner { font-size: 45px; font-weight: 900; text-shadow: 0 0 20px gold; color: white; }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="font-size:11px;">ðŸŸ¢ Online: <span id="on-count">1,824</span></div>
    <div class="bal-box">â‚¹ <span id="balance">0.00</span></div>
</div>

<div class="history" id="hist-bar"></div>
<div class="timer-sec" id="timer">15</div>

<div class="table">
    <div id="card-d-box" class="card"><div id="d-back" class="card-back">D</div><span id="d-card">?</span></div>
    <div style="color:var(--gold); font-weight:900; font-size:22px;">VS</div>
    <div id="card-t-box" class="card"><div id="t-back" class="card-back">T</div><span id="t-card">?</span></div>
</div>

<div class="bet-grid">
    <div class="box dragon-box" onclick="placeBet('dragon')">
        <span class="pool-amt">â‚¹<span id="p-dragon">0</span></span>
        <div id="chips-dragon"></div>
        <div style="position:absolute; bottom:5px; width:100%; text-align:center; font-weight:900; color:var(--dragon); z-index:50;">DRAGON</div>
    </div>
    <div class="box tie-box" onclick="placeBet('tie')">
        <span class="pool-amt">â‚¹<span id="p-tie">0</span></span>
        <div id="chips-tie"></div>
        <div style="position:absolute; bottom:5px; width:100%; text-align:center; font-weight:900; color:var(--gold); font-size:10px; z-index:50;">TIE</div>
    </div>
    <div class="box tiger-box" onclick="placeBet('tiger')">
        <span class="pool-amt">â‚¹<span id="p-tiger">0</span></span>
        <div id="chips-tiger"></div>
        <div style="position:absolute; bottom:5px; width:100%; text-align:center; font-weight:900; color:var(--tiger); z-index:50;">TIGER</div>
    </div>
</div>

<div class="live-players" id="player-row"></div>

<div class="chip-footer">
    <div class="c-btn c10 selected" onclick="setChip(10, this)">10</div>
    <div class="c-btn c50" onclick="setChip(50, this)">50</div>
    <div class="c-btn c100" onclick="setChip(100, this)">100</div>
    <div class="c-btn c500" onclick="setChip(500, this)">500</div>
    <div class="c-btn c1k" onclick="setChip(1000, this)">1K</div>
    <div class="c-btn c5k" onclick="setChip(5000, this)">5K</div>
</div>

<div id="win-overlay"><div class="win-banner" id="win-text">DRAGON WINS</div></div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", 
        databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", 
        projectId: "kalyan-casino" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const phone = localStorage.getItem('userPhone');

    const soundD = new Audio('https://www.fesliyanstudios.com/play-mp3/5643');
    const soundT = new Audio('https://www.fesliyanstudios.com/play-mp3/5644');

    // --- Variables ---
    let bal = 0, currentChip = 10, time = 15, gamesPlayed = 0;
    let poolVals = {dragon:0, tiger:0, tie:0};
    let myBets = {dragon:0, tiger:0, tie:0};
    const colors = {10:'#fff', 50:'#f0f', 100:'#00f', 500:'#0f0', 1000:'#f00', 5000:'#ffd700'};

    // --- Profit Logic Variables ---
    let hourlyTotalBet = 0, hourlyTotalPayout = 0, lastResetTime = Date.now();
    let currentProfitTarget = 0.10, roundCounter = 0;

    const playerPool = ["à¤°à¤¾à¤¹à¥à¤²_KING", "ID_9921", "à¨¸à¤¤à¨¨à¨¾à¨®_PB", "ID_1102", "à®…à®®à®¿à®¤à¯_BOSS", "à¦°à¦¾à¦œà¦¾_77", "à¤…à¤®à¤¨_VIP", "Lucky_Don", "Sonia_Pro", "Tiger_007", "à¤®à¤°à¤¾à¤ à¥€_Power"];
    let bots = [];

    // --- Bot Rotation (Fix) ---
    function refreshPlayers() {
        console.log("Refreshing Players...");
        bots = [];
        let shuffled = [...playerPool].sort(() => 0.5 - Math.random());
        for(let i=0; i<5; i++) bots.push({ name: shuffled[i], bal: Math.floor(Math.random()*85000) + 5000 });
        updateBotUI();
    }

    function updateBotUI() {
        const row = document.getElementById('player-row');
        row.innerHTML = "";
        bots.forEach((b, i) => {
            row.innerHTML += `<div class="player"><div class="p-anim" id="anim-${i}"></div><div class="p-avatar">${b.name}</div><div class="p-bal">â‚¹<span id="p-bal-${i}">${Math.floor(b.bal).toLocaleString()}</span></div></div>`;
        });
    }
    refreshPlayers();

    if(phone) { db.ref('users/'+phone+'/wallet').on('value', s => { bal = s.val() || 0; document.getElementById('balance').innerText = bal.toFixed(2); }); }

    function setChip(v, el) { currentChip = v; document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); }

    function spawnChip(side, amt) {
        const div = document.getElementById('chips-'+side);
        const c = document.createElement('div');
        c.className = 'chip';
        c.style.background = colors[amt];
        c.style.color = (amt === 10 || amt === 5000) ? '#000' : '#fff';
        c.innerText = amt >= 1000 ? (amt/1000)+'K' : amt;
        c.style.left = (Math.random() * 75) + '%';
        c.style.top = (40 + Math.random() * 45) + '%';
        div.appendChild(c);
        if(div.children.length > 120) div.firstChild.remove();
    }

    function placeBet(side) {
        if(time <= 0 || bal < currentChip) return;
        bal -= currentChip;
        db.ref('users/'+phone+'/wallet').set(bal);
        myBets[side] += currentChip;
        spawnChip(side, currentChip);
    }

    // Engine Loop
    setInterval(() => {
        if(time > 0) {
            time--;
            document.getElementById('timer').innerText = time;
            for(let i=0; i<12; i++) {
                setTimeout(() => {
                    let side = Math.random() < 0.48 ? 'dragon' : (Math.random() < 0.96 ? 'tiger' : 'tie');
                    let amt = [100, 1000, 5000][Math.floor(Math.random()*3)];
                    poolVals[side] += amt;
                    document.getElementById('p-'+side).innerText = poolVals[side].toLocaleString();
                    spawnChip(side, amt);
                    let bIdx = Math.floor(Math.random()*5);
                    if(bots[bIdx].bal >= amt) {
                        bots[bIdx].bal -= amt;
                        document.getElementById('p-bal-'+bIdx).innerText = Math.floor(bots[bIdx].bal).toLocaleString();
                        bots[bIdx].lastBet = {side: side, amt: amt};
                    }
                }, Math.random() * 1000);
            }
        } else if(time === 0) { reveal(); time = -5; }
        else { time++; if(time === 0) reset(); }
    }, 1000);

    function reveal() {
        // --- Hourly & Round Profit Logic ---
        roundCounter++;
        if (Date.now() - lastResetTime > 3600000) { hourlyTotalBet = 0; hourlyTotalPayout = 0; lastResetTime = Date.now(); }
        if (roundCounter > 20) { roundCounter = 1; currentProfitTarget = [0.08, 0.10, 0.12][Math.floor(Math.random()*3)]; }

        db.ref('game_settings/dvt').once('value', snap => {
            const set = snap.val() || {mode:'auto'};
            let win = "";

            let dTotal = poolVals['dragon'], tTotal = poolVals['tiger'], tieTotal = poolVals['tie'];
            let roundBet = dTotal + tTotal + tieTotal;
            hourlyTotalBet += roundBet;

            if (set.mode === 'manual') {
                win = set.next;
            } else {
                let hourProfitRate = hourlyTotalBet > 0 ? (hourlyTotalBet - hourlyTotalPayout) / hourlyTotalBet : 0.10;
                let activeTarget = (hourProfitRate < 0.10) ? 0.15 : currentProfitTarget;

                if ((roundBet - (dTotal*1.95)) >= roundBet*activeTarget && dTotal <= tTotal) win = 'dragon';
                else if ((roundBet - (tTotal*1.95)) >= roundBet*activeTarget) win = 'tiger';
                else win = dTotal < tTotal ? 'dragon' : 'tiger';
                
                if (roundCounter === 15) win = 'tie'; // Strategy Tie
            }

            // Cards Logic
            const cardVals = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
            const suits = [{s:'â¤ï¸',c:'suit-red'}, {s:'â™¦ï¸',c:'suit-red'}, {s:'â™ ï¸',c:'suit-black'}, {s:'â™£ï¸',c:'suit-black'}];
            let dI = Math.floor(Math.random()*13), tI = Math.floor(Math.random()*13);
            if(win==='dragon' && dI<=tI) dI = (tI+1)%13 || 12;
            if(win==='tiger' && tI<=dI) tI = (dI+1)%13 || 12;
            if(win==='tie') dI = tI;

            const dS = suits[Math.floor(Math.random()*4)], tS = suits[Math.floor(Math.random()*4)];
            document.getElementById('d-card').innerText = cardVals[dI]+dS.s; document.getElementById('d-card').className = dS.c;
            document.getElementById('t-card').innerText = cardVals[tI]+tS.s; document.getElementById('t-card').className = tS.c;
            document.getElementById('d-back').style.display = 'none'; document.getElementById('t-back').style.display = 'none';

            if(win === 'dragon') { document.getElementById('card-d-box').classList.add('winner-glow'); soundD.play(); }
            else if(win === 'tiger') { document.getElementById('card-t-box').classList.add('winner-glow'); soundT.play(); }

            // Payouts
            let payout = (win==='tie') ? (myBets['tie']*9 + myBets['dragon']*0.5 + myBets['tiger']*0.5) : (myBets[win]*1.95);
            hourlyTotalPayout += payout;
            db.ref('users/'+phone+'/wallet').set(bal + payout);

            // Bots Update & Animation
            bots.forEach((b, i) => {
                const anim = document.getElementById('anim-'+i);
                if(b.lastBet && b.lastBet.side === win) {
                    let wAmt = b.lastBet.amt * 1.95; b.bal += wAmt;
                    anim.innerText = "+"+Math.floor(wAmt); anim.style.color = "#0f0";
                } else { anim.innerText = "LOSS"; anim.style.color = "#f00"; }
                anim.style.opacity = "1"; anim.style.transform = "translateY(-15px)";
                setTimeout(() => { anim.style.opacity = "0"; anim.style.transform = "translateY(0)"; }, 2000);
                document.getElementById('p-bal-'+i).innerText = Math.floor(b.bal).toLocaleString();
                delete b.lastBet;
            });

            document.getElementById('win-text').innerText = win.toUpperCase() + " WINS";
            document.getElementById('win-overlay').style.display = 'block';
            const h = document.getElementById('hist-bar');
            h.innerHTML = `<div class="hist-item ${win==='dragon'?'h-d':(win==='tiger'?'h-t':'h-ti')}">${win==='dragon'?'D':(win==='tiger'?'T':'Ti')}</div>` + h.innerHTML;

            // --- BOT EXIT SYSTEM (Fix) ---
            gamesPlayed++; 
            if(gamesPlayed >= 10) { 
                gamesPlayed = 0; 
                setTimeout(() => {
                    document.getElementById('player-row').style.opacity = "0.3";
                    setTimeout(() => { refreshPlayers(); document.getElementById('player-row').style.opacity = "1"; }, 1500);
                }, 2000);
            }
        });
    }

    function reset() {
        document.getElementById('win-overlay').style.display = 'none';
        document.getElementById('d-back').style.display = 'flex';
        document.getElementById('t-back').style.display = 'flex';
        document.getElementById('card-d-box').classList.remove('winner-glow');
        document.getElementById('card-t-box').classList.remove('winner-glow');
        document.querySelectorAll('.chip').forEach(c => c.remove());
        poolVals = {dragon:0, tiger:0, tie:0}; myBets = {dragon:0, tiger:0, tie:0};
        ['dragon','tiger','tie'].forEach(s => document.getElementById('p-'+s).innerText = "0");
        time = 15;
    }
</script>
</body>
</html>
