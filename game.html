<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRAGON TIGER MASTER - NO MISTAKE</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --dragon: #ff3333; --tiger: #33aaff; --gold: #ffd700; --tie: #2ecc71; }
        body { margin: 0; background: #050505; font-family: 'Arial Black', sans-serif; overflow: hidden; color: white; user-select: none; }
        .top-bar { display: flex; justify-content: space-between; padding: 10px; background: #111; border-bottom: 2px solid var(--gold); }
        .bal-box { background: #222; border: 1.5px solid var(--gold); padding: 5px 15px; border-radius: 20px; color: var(--gold); font-weight: bold; }
        .online-count { font-size: 11px; color: #0f0; font-weight: bold; margin-top: 2px; }
        .history { display: flex; gap: 4px; padding: 8px; justify-content: flex-start; background: rgba(0,0,0,0.8); height: 25px; overflow-x: auto; border-bottom: 1px solid #333; }
        .hist-item { width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 1px solid #fff; flex-shrink: 0; }
        .h-d { background: var(--dragon); } .h-t { background: var(--tiger); } .h-ti { background: var(--tie); }
        .timer-sec { text-align: center; font-size: 45px; color: var(--gold); margin: 5px 0; text-shadow: 0 0 10px #f39c12; }
        .table { display: flex; justify-content: center; gap: 20px; align-items: center; height: 110px; }
        .card { width: 70px; height: 100px; background: #fff !important; border-radius: 8px; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 28px; color: #000; border: 2px solid #999; }
        .card-back { background: linear-gradient(45deg, #800, #f00); position: absolute; width: 100%; height: 100%; z-index: 5; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: gold; font-size: 30px; border: 1px solid gold; }
        .bet-grid { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .box { width: 115px; height: 180px; border: 3px solid rgba(255,255,255,0.1); border-radius: 15px; position: relative; background: rgba(255,255,255,0.02); overflow: hidden; }
        .dragon-box { border-color: var(--dragon); } .tiger-box { border-color: var(--tiger); } .tie-box { width: 85px; height: 140px; border-color: var(--tie); }
        .pool-amt { display: block; background: rgba(0,0,0,0.8); color: #0f0; text-align: center; font-size: 13px; padding: 4px; font-weight: bold; height: 22px; }
        .chip { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #fff; position: absolute; z-index: 10; font-size: 8px; font-weight: 900; display: flex; align-items: center; justify-content: center; pointer-events: none; box-shadow: 0 2px 4px #000; transition: all 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .live-players { display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; padding: 8px 0; background: rgba(0,0,0,0.95); position: fixed; bottom: 85px; width: 100%; border-top: 2px solid #333; }
        .player { text-align: center; position: relative; }
        .p-avatar { width: 30px; height: 30px; background: #222; border: 1.5px solid gold; border-radius: 50%; margin: 0 auto; line-height: 30px; font-size: 7px; color: #fff; }
        .chip-footer { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: center; gap: 6px; padding: 12px 0; border-top: 2px solid var(--gold); }
        .c-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 11px; cursor: pointer; border: 2px dashed #fff; color: white; }
        .selected { transform: scale(1.1) translateY(-5px); border: 2.5px solid var(--gold) !important; box-shadow: 0 0 15px var(--gold); }
        #win-overlay { position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; font-size: 28px; font-weight: 900; background: rgba(0,0,0,0.95); padding: 15px 30px; border-radius: 10px; border: 3px solid var(--gold); }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <div id="live-date" style="font-size:10px; color:var(--gold)">--/--/--</div>
        <div class="online-count"><span id="user-online">543</span> Players Online</div>
    </div>
    <div class="bal-box">â‚¹ <span id="balance">0.00</span></div>
</div>

<div class="history" id="hist-bar"></div>
<div class="timer-sec" id="timer">15</div>

<div class="table">
    <div id="card-d" class="card"><div class="card-back">D</div><div id="d-v"></div></div>
    <div style="color:var(--gold); font-size:20px;">VS</div>
    <div id="card-t" class="card"><div class="card-back">T</div><div id="t-v"></div></div>
</div>

<div class="bet-grid">
    <div class="box dragon-box" onclick="placeBet('dragon')"><span class="pool-amt">â‚¹<span id="p-dragon">0</span></span><div id="chips-dragon"></div></div>
    <div class="box tie-box" onclick="placeBet('tie')"><span class="pool-amt">â‚¹<span id="p-tie">0</span></span><div id="chips-tie"></div></div>
    <div class="box tiger-box" onclick="placeBet('tiger')"><span class="pool-amt">â‚¹<span id="p-tiger">0</span></span><div id="chips-tiger"></div></div>
</div>

<div class="live-players" id="player-row"></div>

<div class="chip-footer">
    <div class="c-btn" id="chip10" style="background:#ffffff; color:#000" onclick="setChip(10, this)">10</div>
    <div class="c-btn" id="chip50" style="background:#e91e63;" onclick="setChip(50, this)">50</div>
    <div class="c-btn" id="chip100" style="background:#2196f3;" onclick="setChip(100, this)">100</div>
    <div class="c-btn" id="chip500" style="background:#4caf50; color:#000" onclick="setChip(500, this)">500</div>
    <div class="c-btn" id="chip1000" style="background:#f44336;" onclick="setChip(1000, this)">1K</div>
    <div class="c-btn" id="chip5000" style="background:#ffd700; color:#000" onclick="setChip(5000, this)">5K</div>
</div>

<div id="win-overlay">WINNER</div>

<script>
    // Config and Firebase Init
    const firebaseConfig = { apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", projectId: "kalyan-casino" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const phone = localStorage.getItem('userPhone');

    const chipConfig = { 10:{color:"#fff",text:"10",font:"#000"}, 50:{color:"#e91e63",text:"50",font:"#fff"}, 100:{color:"#2196f3",text:"100",font:"#fff"}, 500:{color:"#4caf50",text:"500",font:"#000"}, 1000:{color:"#f44336",text:"1K",font:"#fff"}, 5000:{color:"#ffd700",text:"5K",font:"#000"} };
    let totalBal=0, currentChip=10, time=15, isBetting=false, pool={dragon:0, tiger:0, tie:0}, myBets={dragon:0, tiger:0, tie:0};
    const deck = ["A","2","3","4","5","6","7","8","9","10","J","Q","K"];

    // âœ… FIXED GLOBAL HISTORY: 10-Round Freeze & Reset Sync
    db.ref('games/dragon_tiger/history').limitToLast(10).on('value', snap => {
        const h = document.getElementById('hist-bar');
        const data = snap.val() || {};
        const records = Object.values(data);
        
        // FREEZE LOGIC: Agar reset ho gaya toh purane circles mat hatao (jab tak naya na aaye)
        if (records.length === 0) return;

        let html = "";
        records.forEach(v => {
            let cls = (v==='dragon')?'h-d':(v==='tiger'?'h-t':'h-ti');
            let char = (v==='dragon'?'D':v==='tiger'?'T':'t');
            html += `<div class="hist-item ${cls}">${char}</div>`;
        });
        h.innerHTML = html;
        h.scrollLeft = h.scrollWidth;

        // Background Reset: Jab 10 poore hon, tab delete command bhej do
        if (records.length >= 10) {
            setTimeout(() => { db.ref('games/dragon_tiger/history').remove(); }, 8000);
        }
    });

    // ðŸŸ¢ ALL PLAYER BOTS (NO CODE REMOVED)
    let bots = [];
    const names = ["VIP_1", "Raja", "Lucky", "Don", "Pro", "Jatt", "King", "Mega", "Smart", "Ace"];
    function initBots() {
        for(let i=0; i<10; i++) bots[i] = { name: names[i]+"_"+Math.floor(Math.random()*9), bal: Math.floor(Math.random()*80000)+50000 };
        renderBots();
    }
    function renderBots() {
        const row = document.getElementById('player-row'); row.innerHTML = "";
        bots.forEach(b => row.innerHTML += `<div class="player"><div class="p-avatar">${b.name}</div><div style="font-size:8px;color:#0f0">â‚¹${b.bal.toLocaleString()}</div></div>`);
    }

    // ðŸŸ¢ CONTINUOUS ENGINE
    function startEngine() {
        resetUI(); time = 15; isBetting = true;
        document.getElementById('timer').innerText = time;
        let loop = setInterval(() => {
            if(time > 0) {
                time--; document.getElementById('timer').innerText = time;
                if(time > 2) botBetting();
            } else {
                clearInterval(loop); isBetting = false; processResult();
            }
        }, 1000);
    }

    function botBetting() {
        bots.forEach(b => {
            if(Math.random() > 0.3) {
                let s = ['dragon','tiger','tie'][Math.floor(Math.random()*3)];
                let a = [50, 100, 500, 1000, 5000][Math.floor(Math.random()*5)];
                if(b.bal >= a) { b.bal -= a; pool[s] += a; updatePoolUI(); spawnChip(s, a); }
            }
        });
        renderBots();
    }

    function spawnChip(side, amt) {
        const div = document.getElementById('chips-' + side);
        const config = chipConfig[amt] || chipConfig[10];
        const c = document.createElement('div');
        c.className = 'chip'; c.style.background = config.color; c.style.color = config.font;
        c.innerText = config.text;
        c.style.left = Math.random() > 0.5 ? '-100px' : '200%';
        c.style.top = '100%'; div.appendChild(c);
        setTimeout(() => { c.style.left = (Math.random()*75+5)+"%"; c.style.top = (Math.random()*60+20)+"%"; }, 10);
    }

    function updatePoolUI() {
        document.getElementById('p-dragon').innerText = pool.dragon.toLocaleString();
        document.getElementById('p-tiger').innerText = pool.tiger.toLocaleString();
        document.getElementById('p-tie').innerText = pool.tie.toLocaleString();
    }

    function processResult() {
        db.ref('games/dragon_tiger/settings').once('value', snap => {
            const set = snap.val() || {mode:'auto'};
            let win = (pool.dragon <= pool.tiger) ? 'dragon' : 'tiger';
            if(set.mode === 'manual' && set.next) win = set.next;
            
            let d_i = Math.floor(Math.random()*13), t_i = Math.floor(Math.random()*13);
            if(win==='dragon' && d_i <= t_i) [d_i, t_i] = [t_i, d_i];
            if(win==='tiger' && t_i <= d_i) [t_i, d_i] = [d_i, t_i];
            if(win==='tie') d_i = t_i;

            document.getElementById('d-v').innerText = deck[d_i];
            document.getElementById('t-v').innerText = deck[t_i];
            document.querySelectorAll('.card-back').forEach(b => b.style.display = 'none');
            document.getElementById('win-overlay').innerText = win.toUpperCase() + " WINS";
            document.getElementById('win-overlay').style.display = 'block';
            
            db.ref('games/dragon_tiger/history').push(win);
            setTimeout(() => { startEngine(); }, 7000);
        });
    }

    function placeBet(side) {
        if(!isBetting || time <= 2 || totalBal < currentChip) return;
        db.ref('users/'+phone).once('value', s => {
            const d = s.val() || {}; let b = parseFloat(d.balance||0), w = parseFloat(d.winning_balance||0);
            if(b >= currentChip) b -= currentChip; else if(w >= currentChip) w -= currentChip; else return;
            db.ref('users/'+phone).update({balance:b, winning_balance:w});
            myBets[side] += currentChip; pool[side] += currentChip;
            updatePoolUI(); spawnChip(side, currentChip);
        });
    }

    function resetUI() {
        document.getElementById('win-overlay').style.display = 'none';
        document.querySelectorAll('.card-back').forEach(b => b.style.display = 'flex');
        document.querySelectorAll('.chip').forEach(c => c.remove());
        pool = {dragon:0, tiger:0, tie:0}; myBets = {dragon:0, tiger:0, tie:0};
        updatePoolUI();
        document.getElementById('live-date').innerText = new Date().toLocaleDateString();
    }

    function setChip(v, el) {
        currentChip = v;
        document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected'));
        el.classList.add('selected');
    }

    if(phone) {
        db.ref('users/'+phone).on('value', s => {
            const d = s.val() || {};
            totalBal = (parseFloat(d.balance)||0) + (parseFloat(d.winning_balance)||0);
            document.getElementById('balance').innerText = totalBal.toFixed(2);
        });
    }

    initBots();
    document.getElementById('chip10').classList.add('selected');
    startEngine();
</script>
</body>
</html>
