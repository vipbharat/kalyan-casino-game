<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DRAGON TIGER - KALYAN VIP CASINO</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --dragon: #ff3333; --tiger: #33aaff; --gold: #ffd700; --tie: #2ecc71; }
        body { margin: 0; background: #050505; font-family: 'Arial Black', sans-serif; overflow-x: hidden; overflow-y: auto; color: white; user-select: none; padding-bottom: 150px; }
        .top-bar { display: flex; justify-content: space-between; padding: 10px; background: #111; border-bottom: 2px solid var(--gold); }
        .bal-box { background: #222; border: 1.5px solid var(--gold); padding: 5px 15px; border-radius: 20px; color: var(--gold); font-weight: bold; }
        
        .admin-msg-bar { background: #800; color: #fff; font-size: 13px; height: 22px; line-height: 22px; overflow: hidden; white-space: nowrap; border-bottom: 2px solid var(--gold); font-weight: bold; letter-spacing: 1px; }

        .timer-sec { text-align: center; font-size: 45px; color: var(--gold); margin: 15px 0; text-shadow: 0 0 10px #f39c12; }
        
        .table { display: flex; justify-content: center; gap: 25px; align-items: center; height: 100px; position: relative; z-index: 10; margin-bottom: 20px; }
        .card { width: 68px; height: 98px; border-radius: 6px; position: relative; display: flex; align-items: center; justify-content: center; border: 2px solid var(--gold); background: transparent; box-shadow: 0 4px 8px rgba(0,0,0,0.8); }
        .card-back { background: url('https://deckofcardsapi.com/static/img/back.png') center/cover; position: absolute; width: 100%; height: 100%; z-index: 15; border-radius: 4px; }
        #d-v, #t-v { width: 100%; height: 100%; border-radius: 4px; overflow: hidden; }
        #d-v img, #t-v img { width: 100%; height: 100%; object-fit: fill; border-radius: 4px; background: #fff; }
        
        #win-overlay { position: fixed; top: 25%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; display: none; font-size: 24px; font-weight: 900; background: rgba(0,0,0,0.95); padding: 8px 25px; border-radius: 8px; border: 3px solid var(--gold); color: white; text-align: center; box-shadow: 0 0 15px var(--gold); white-space: nowrap; }

        .bet-grid { display: flex; justify-content: center; gap: 8px; margin-top: 5px; }
        .box-container { display: flex; flex-direction: column; align-items: center; }
        .m-amt { font-size: 14px; color: #0f0; font-weight: bold; margin-bottom: 2px; }
        .box { width: 110px; height: 170px; border: 3px solid rgba(255,255,255,0.1); border-radius: 15px; position: relative; background: rgba(255,255,255,0.02); overflow: hidden; }
        .dragon-box { border-color: var(--dragon); } .tiger-box { border-color: var(--tiger); } .tie-box { width: 85px; height: 135px; border-color: var(--tie); margin-top: 25px; }
        
        .chip { width: 22px; height: 22px; border-radius: 50%; border: 1px solid #fff; position: absolute; z-index: 20; font-size: 9px; font-weight: 900; display: flex; align-items: center; justify-content: center; pointer-events: none; transition: all 0.5s; box-shadow: 0 1px 3px #000; }
        
        .live-players { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; padding: 5px 0; background: rgba(0,0,0,0.95); position: fixed; bottom: 70px; width: 100%; border-top: 1px solid #333; z-index: 50; }
        .player { text-align: center; } 
        .p-avatar { width: 30px; height: 30px; background: #222; border: 1.5px solid gold; border-radius: 50%; margin: 0 auto; line-height: 28px; font-size: 7px; color: #fff; overflow: hidden; text-transform: uppercase; }
        
        .chip-footer { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: center; gap: 8px; padding: 12px 0; border-top: 2px solid var(--gold); z-index: 100; }
        .c-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 13px; cursor: pointer; border: 2px dashed #fff; color: white; }
        .selected { transform: scale(1.1); border: 3px solid var(--gold) !important; box-shadow: 0 0 10px var(--gold); }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <div id="live-date" style="font-size:10px; color:var(--gold)">--/--/--</div>
        <div style="font-size:10px; color:#0f0; font-weight:bold;">1,248 Online</div>
    </div>
    <div class="bal-box">₹ <span id="balance">0.00</span></div>
</div>

<div class="admin-msg-bar">
    <marquee id="admin-note">Welcome to KALYAN VIP CASINO!</marquee>
</div>

<div class="timer-sec" id="timer">15</div>
<div id="win-overlay">WINNER</div>

<div class="table">
    <div id="card-d" class="card"><div class="card-back" id="back-d"></div><div id="d-v"></div></div>
    <div style="color:var(--gold); font-size:20px; z-index:20; font-weight:900;">VS</div>
    <div id="card-t" class="card"><div class="card-back" id="back-t"></div><div id="t-v"></div></div>
</div>

<div class="bet-grid">
    <div class="box-container">
        <div class="m-amt" id="m-dragon">₹0</div>
        <div class="box dragon-box" onclick="placeBet('dragon')"><div id="chips-dragon"></div></div>
    </div>
    <div class="box-container">
        <div class="m-amt" id="m-tie">₹0</div>
        <div class="box tie-box" onclick="placeBet('tie')"><div id="chips-tie"></div></div>
    </div>
    <div class="box-container">
        <div class="m-amt" id="m-tiger">₹0</div>
        <div class="box tiger-box" onclick="placeBet('tiger')"><div id="chips-tiger"></div></div>
    </div>
</div>

<div class="live-players" id="player-row"></div>

<div class="chip-footer">
    <div class="c-btn" id="chip10" style="background:white; color:black" onclick="setChip(10, this)">10</div>
    <div class="c-btn" id="chip100" style="background:#2196f3;" onclick="setChip(100, this)">100</div>
    <div class="c-btn" id="chip500" style="background:#4caf50;" onclick="setChip(500, this)">500</div>
    <div class="c-btn" id="chip1000" style="background:#f44336;" onclick="setChip(1000, this)">1K</div>
    <div class="c-btn" id="chip5000" style="background:var(--gold); color:black" onclick="setChip(5000, this)">5K</div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyCy2zsDDJeVTQEbHCenkLIlz3lWWyo-Pqo", databaseURL: "https://kalyan-casino-default-rtdb.firebaseio.com", projectId: "kalyan-casino" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const phone = localStorage.getItem('userPhone');

    const chipConfig = { 10:{c:"#fff",t:"10",f:"#000"}, 100:{c:"#2196f3",t:"100",f:"#fff"}, 500:{c:"#4caf50",t:"500",f:"#fff"}, 1000:{c:"#f44336",t:"1K",f:"#fff"}, 5000:{c:"#ffd700",t:"5K",f:"#000"} };
    let totalBal=0, currentChip=10, isBetting=false, adminCommand=null;
    let realPool={dragon:0, tiger:0, tie:0}, botPool={dragon:0, tiger:0, tie:0}, myBets = { dragon: 0, tiger: 0, tie: 0 };
    const deckCodes = ["A","2","3","4","5","6","7","8","9","0","J","Q","K"];
    
    // Bots logic
    let botsData = [];
    let lastWinSide = '';

    function initBots() {
        for(let i=0; i<10; i++) {
            botsData.push({
                id: Math.floor(Math.random()*8999)+1000,
                bal: Math.floor(Math.random() * 90001) + 10000,
                currentBetSide: '',
                currentBetAmt: 0
            });
        }
    }
    initBots();

    db.ref('game_settings/dvt').on('value', s => { adminCommand = s.val(); });
    db.ref('admin_settings/notification').on('value', s => { if(s.val()) document.getElementById('admin-note').innerText = s.val(); });

    function startEngine() {
        const loopTime = 22000; 
        setInterval(() => {
            const now = Date.now();
            const cyclePos = now % loopTime;
            const remaining = Math.floor((15000 - cyclePos) / 1000);

            if (cyclePos < 15000) {
                if(!isBetting) { isBetting = true; resetUI(); }
                document.getElementById('timer').innerText = remaining > 0 ? remaining : "0";
                if(remaining > 2) botBetting();
            } else {
                if(isBetting) { isBetting = false; document.getElementById('timer').innerText = "0"; processResult(); }
            }
        }, 1000);
    }

    function botBetting() {
        let loopCount = Math.floor(Math.random() * 4) + 3; 
        for(let i=0; i<loopCount; i++){
            let botIndex = Math.floor(Math.random()*botsData.length);
            let s = ['dragon','tiger','tie'][Math.floor(Math.random()*3)];
            let a = [10, 100, 500, 1000, 5000][Math.floor(Math.random()*5)]; 
            
            if(s === 'tie' && botPool.tie > 3000) s = Math.random() > 0.5 ? 'dragon' : 'tiger';
            
            // Bot balance minus
            if(botsData[botIndex].bal >= a) {
                botsData[botIndex].bal -= a;
                botsData[botIndex].currentBetSide = s;
                botsData[botIndex].currentBetAmt += a;
                botPool[s] += a; 
                spawnChip(s, a);
            }
        }
        updatePoolUI();
        updateBotsUI();
    }

    function processResult() {
        try {
            let win;
            if (adminCommand && adminCommand.mode === 'manual') { win = adminCommand.result; } 
            else {
                if (realPool.dragon < realPool.tiger) win = 'dragon';
                else if (realPool.tiger < realPool.dragon) win = 'tiger';
                else win = Math.random() > 0.5 ? 'dragon' : 'tiger';
                if(Math.random() < 0.04) win = 'tie';
            }
            lastWinSide = win;

            let d_i = Math.floor(Math.random() * 13), t_i;
            if (win === 'dragon') t_i = d_i > 0 ? Math.floor(Math.random() * d_i) : 0;
            else if (win === 'tiger') t_i = d_i < 12 ? Math.floor(Math.random() * (12 - d_i)) + (d_i + 1) : 12;
            else t_i = d_i;

            document.getElementById('d-v').innerHTML = `<img src="https://deckofcardsapi.com/static/img/${deckCodes[d_i]}S.png">`;
            document.getElementById('t-v').innerHTML = `<img src="https://deckofcardsapi.com/static/img/${deckCodes[t_i]}D.png">`;
            document.getElementById('back-d').style.display = 'none';
            document.getElementById('back-t').style.display = 'none';
            
            const winBox = document.getElementById('win-overlay');
            winBox.innerText = win.toUpperCase() + " WINS";
            winBox.style.display = 'block';

            // Bot Winning logic (Balance update)
            botsData.forEach(bot => {
                if(bot.currentBetSide === win) {
                    let multi = (win === 'tie') ? 9 : 2;
                    bot.bal += (bot.currentBetAmt * multi);
                }
                bot.currentBetSide = '';
                bot.currentBetAmt = 0;
            });

            let payout = 0;
            if (win === 'dragon') payout = myBets.dragon * 1.95;
            else if (win === 'tiger') payout = myBets.tiger * 1.95;
            else if (win === 'tie') payout = (myBets.tie * 9) + (myBets.dragon * 0.5) + (myBets.tiger * 0.5);

            if (payout > 0 && phone) {
                db.ref('users/'+phone).once('value', s => {
                    let b = s.val() ? s.val().balance : 0;
                    db.ref('users/'+phone).update({balance: b + payout});
                });
            }
            setTimeout(updateBotsUI, 2000); // Update balance after win
        } catch(e) {}
    }

    function updateBotsUI() {
        let bHtml = "";
        botsData.forEach(bot => {
            bHtml += `<div class="player">
                        <div class="p-avatar">ID</div>
                        <div style="font-size:8px;color:#0f0">ID ${bot.id}</div>
                        <div style="font-size:7px;color:#ffd700">₹${Math.floor(bot.bal).toLocaleString()}</div>
                      </div>`;
        });
        document.getElementById('player-row').innerHTML = bHtml;
    }

    function placeBet(side) {
        if(!isBetting || document.getElementById('timer').innerText === "0" || totalBal < currentChip) return;
        db.ref('users/'+phone).once('value', s => {
            let b = s.val() ? s.val().balance : 0; 
            if(b >= currentChip) {
                db.ref('users/'+phone).update({balance: b - currentChip});
                realPool[side] += currentChip; myBets[side] += currentChip;
                updatePoolUI(); spawnChip(side, currentChip);
            }
        });
    }

    function updatePoolUI() {
        document.getElementById('m-dragon').innerText = "₹"+(realPool.dragon + botPool.dragon).toLocaleString();
        document.getElementById('m-tiger').innerText = "₹"+(realPool.tiger + botPool.tiger).toLocaleString();
        document.getElementById('m-tie').innerText = "₹"+(realPool.tie + botPool.tie).toLocaleString();
    }

    function spawnChip(side, amt) {
        const div = document.getElementById('chips-' + side);
        const c = document.createElement('div');
        const config = chipConfig[amt] || chipConfig[10];
        c.className = 'chip'; c.style.background = config.c; c.style.color = config.f; c.innerText = config.t;
        c.style.left = (Math.random()*70+10)+"%"; c.style.top = (Math.random()*70+10)+"%";
        div.appendChild(c);
        if(div.children.length > 40) div.firstChild.remove(); 
    }

    function resetUI() {
        document.getElementById('win-overlay').style.display = 'none';
        document.getElementById('back-d').style.display = 'block';
        document.getElementById('back-t').style.display = 'block';
        document.getElementById('d-v').innerHTML = ""; document.getElementById('t-v').innerHTML = "";
        document.querySelectorAll('.chip').forEach(c => c.remove());
        realPool={dragon:0, tiger:0, tie:0}; botPool={dragon:0, tiger:0, tie:0}; myBets={dragon:0, tiger:0, tie:0};
        updatePoolUI();
        updateBotsUI();
        document.getElementById('live-date').innerText = new Date().toLocaleDateString();
    }

    function setChip(v, el) { currentChip = v; document.querySelectorAll('.c-btn').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); }
    if(phone) db.ref('users/'+phone).on('value', s => { totalBal = s.val() ? s.val().balance : 0; document.getElementById('balance').innerText = totalBal.toFixed(2); });
    
    document.getElementById('chip10').classList.add('selected');
    startEngine();
</script>
</body>
</html>
